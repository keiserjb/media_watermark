<?php

/**
 * @file
 * Watermark media module
 */

/**
 * Implements hook_permission().
 */
function media_watermark_permission() {
  return array(
    'media watermark control' => array(
      'title' => t('Control watermark'),
      'description' => t('Checkbox appear for controlling watermark at file uploading.'),
    ),
  );
}

/**
 * Implements hook_help().
 */
function media_watermark_help($path, $arg) {
  switch ($path) {
    case 'admin/content/media':
      return '<p>' . t('If you need to add file press + Add file.
      Then if you need to add watermarks you need to create any => ')
      . '<a href="' . base_path() . 'admin/config/media/watermark/add">'
      . t('Create watermark')
      . '</a></p>';
      break;

    case 'admin/config/media/watermark/add':
      $link = 'https://drupal.org/files/instructions%20for%20media%20watermark%20module_0.odt';
      $help = '<p>' . t('If you need details about parameters, please follow this link');
      $help .= ' <a href="' . $link . '">Media Watermark Documentation</a>' . '</p>';
      return $help;
      break;

    case 'admin/config/media/watermark':
      $link = 'https://drupal.org/files/instructions%20for%20media%20watermark%20module_0.odt';
      $help = '<p>' . t('Follow this link to get documentation:');
      $help .= ' <a href="' . $link . '">Media Watermark Documentation</a>' . '</p>';
      return $help;
      break;
  }
}

/**
 * Implements hook_menu().
 */
function media_watermark_menu() {
  $items = array();

  $items['admin/config/media/watermark'] = array(
    'title' => 'Media Watermark settings',
    'description' => 'Control how to apply watermark.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('media_watermark_edit_settings'),
    'access arguments' => array('administer site configuration'),
    'file' => 'includes/media_watermark_edit.admin.inc',
    'type' => MENU_NORMAL_ITEM,
  );

  $items['admin/config/media/watermark/all'] = array(
    'title' => 'Edit Watermarks',
    'description' => 'Edit watermarks',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('media_watermark_edit_settings'),
    'access arguments' => array('administer site configuration'),
    'file' => 'includes/media_watermark_edit.admin.inc',
    'weight' => 1,
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );

  $items['admin/config/media/watermark/add'] = array(
    'title' => 'Add watermark',
    'description' => 'Add watermark.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('media_watermark_form'),
    'access arguments' => array('administer site configuration'),
    'file' => 'includes/media_watermark_add.admin.inc',
    'weight' => 2,
    'type' => MENU_LOCAL_TASK,
  );

  $items['admin/config/media/watermark/edit/%'] = array(
    'title' => 'Add watermark',
    'description' => 'Add watermark.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('media_watermark_form'),
    'access arguments' => array('administer site configuration'),
    'file' => 'includes/media_watermark_add.admin.inc',
    'type' => MENU_NORMAL_ITEM,
  );
  $items['admin/config/media/watermark/delete/%'] = array(
    'title' => 'Delete watermark',
    'description' => 'Delete watermark.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('media_watermark_delete_form'),
    'access arguments' => array('administer site configuration'),
    'file' => 'includes/media_watermark_delete.admin.inc',
    'type' => MENU_NORMAL_ITEM,
  );

  return $items;
}

/**
 * Function to get all watermarks array stored in db.
 *
 * @return array
 *   all stored watermarks
 */
function media_watermark_get_watermarks() {
  $result = db_query("SELECT * FROM {media_watermark}");
  if (isset($result) && !empty($result)) {
    return $result->fetchAll(PDO::FETCH_ASSOC);
  }
}

/**
 * Function to get watermark name.
 *
 * @param string $id
 *   watermark id
 *
 * @return string
 *   watermark name
 */
function media_watermark_get_name($id) {
  $result = db_query('SELECT name FROM {media_watermark} WHERE wid = :wid', array(':wid' => $id));
  $result = $result->fetchObject();
  if (!empty($result)) {
    $result = $result->name;
    return $result;
  }
}

/**
 * Function to get watermark object.
 *
 * @param string $id
 *   watermark id
 *
 * @return object
 *   watermark object
 */
function media_watermark_get_watermark($id) {
  $result = db_query('SELECT * FROM {media_watermark} WHERE wid = :wid', array(':wid' => $id));
  $result = $result->fetchObject();
  if (!empty($result)) {
    return $result;
  }
}

/**
 * Implements hook_form_alter().
 */
function media_watermark_form_alter(&$form, &$form_state, $form_id) {
  if (in_array($form_id, array(
    'file_entity_add_upload_multiple',
    'file_entity_add_upload',
    'media_add_upload',
    'media_tab_upload',
  ))
  ) {
    if (empty($form['field_file_image_alt_text']) && empty($form['field_file_image_title_text'])) {
      $watermarks = media_watermark_get_watermarks();
      if (!empty($watermarks)) {
        $form['no_watermark'] = array(
          '#type' => 'checkbox',
          '#title' => t('No watermark'),
          '#default_value' => FALSE,
          '#weight' => -10,
        );

        $names = media_watermark_prepare_names($watermarks);
        $form['watermarks_names'] = array(
          '#type' => 'select',
          '#options' => $names,
          '#description' => t('To edit watermark just click on its image'),
          '#weight' => -9,
        );
        //Hide select list if one watermark.
        if (count($watermarks) == 1) {
          $form['watermarks_names']['#prefix'] = '<div class="hide-select-list">';
          $form['watermarks_names']['#suffix'] = '</div>';
        }
        $images = media_watermark_prepare_images($watermarks);
        $form['watermarks_images'] = array(
          '#type' => 'item',
          '#markup' => $images,
          '#weight' => -8,
        );
        $form['#attached']['js'] = array(
          drupal_get_path('module', 'media_watermark') . '/media_watermark.js',
        );
        // Add custom submit function.
        array_unshift($form['#submit'], 'media_watermark_add_watermark');
      }
    }
  }
}

/**
 * Callback to add watermark.
 *
 * @param array $form
 *   form array
 * @param array $form_state
 *   form state array
 */
function media_watermark_add_watermark(&$form, &$form_state) {
  if (!$form_state['values']['no_watermark']) {
    // Uploaded file.
    if (is_object($form_state['values']['upload'])) {
      $file_path = drupal_realpath($form_state['values']['upload']->uri);
      media_watermark_create_image($file_path, $form_state);
    }
    elseif (is_int($form_state['values']['upload']) || is_string($form_state['values']['upload'])) {
      $uploaded = file_load($form_state['values']['upload']);
      $file_path = drupal_realpath($uploaded->uri);
      media_watermark_create_image($file_path, $form_state);
    }
    else {
      media_watermark_add_upload_multiple_submit($form, $form_state);
    }
  }
}

/**
 * Function to create jpeg image file.
 *
 * @param string $file_path
 *   temporary path of uploaded file
 *
 * @param array $form_state
 *   array of form state
 */
function media_watermark_create_image($file_path, $form_state) {
  $watermark_obj = db_query("SELECT * FROM {media_watermark} WHERE fid = :fid", array(':fid' => $form_state['values']['watermarks_names']));
  $watermark_obj = $watermark_obj->fetchObject();
  $watermark_file = file_load($watermark_obj->fid);
  $watermark_filepath = drupal_realpath($watermark_file->uri);
  $watermark_extension = media_watermark_get_file_extension($watermark_filepath);
  //Check uploaded image extension.
  $ext = media_watermark_get_file_extension($file_path);
  if ($ext == 'jpg' || $ext == 'jpeg') {
    $img = imagecreatefromjpeg($file_path);
  }
  elseif ($ext == 'png') {
    $img = imagecreatefrompng($file_path);
  }
  elseif ($ext == 'gif') {
    $img = imagecreatefromgif($file_path);
  }
  if (!empty($img)) {
    ob_start();
    if ($watermark_extension == 'png') {
      $watermark_img = imagecreatefrompng($watermark_filepath);
    }
    elseif ($watermark_extension == 'gif') {
      $watermark_img = imagecreatefromgif($watermark_filepath);
    }
    $watermark = new MediaWatermark();
    $im = $watermark->addWatermark($img, $watermark_img, $watermark_obj, $ext);
    imagepng($im, $file_path);
    imagedestroy($im);
    ob_end_clean();
  }

}

/**
 * Function media_watermark_prepare_names().
 *
 * @param array $results
 *   watermarks array
 *
 * @return array
 *   names array
 */
function media_watermark_prepare_names($results) {
  $names = array();
  foreach ($results as $key => $value) {
    $names[$value['fid']] = $value['name'];
  }
  return $names;
}

/**
 * Function media_watermark_prepare_images().
 *
 * @todo move into theme function.
 *
 * @param array $results
 *   watermark images file id array
 *
 * @return string
 *   html of watermark images
 */
function media_watermark_prepare_images($results) {
  $images = '';
  foreach ($results as $key => $value) {
    $file = file_load($value['fid']);
    $image = theme('image_formatter', array(
      'item' => array(
        'uri' => $file->uri,
        'alt' => t('Edit'),
        'title' => t('Edit'),
      ),
      'path' => array(
        'path' => 'admin/config/media/watermark/edit/' . $value['wid'],
        'options' => array('html' => TRUE),
      ),
      'image_style' => 'media_watermark',
    ));
    $images .= '<div class="image-hidden" id="image-' . $value['fid'] . '">' . $image . '</div>';
  }
  return $images;
}

/**
 * Batch operation: prepare batch to add watermarks to images.
 *
 * @param array $form_state
 *   form state array
 *
 * @return array
 *   batch operations array
 */
function media_watermark_prepare_batch($form_state) {
  drupal_set_message('Adding watermarks.');

  foreach ($form_state['files'] as $key => $value) {
    $file_path = drupal_realpath($value->uri);
    $operations[] = array(
      'media_watermark_process_multiple_images',
      array($file_path, $form_state),
    );
  }

  $batch = array(
    'operations' => $operations,
    'finished' => 'media_watermark_batch_finished',
    'init_message' => 'Prepare data.',
    'progress_message' => 'Executed @current from @total.',
    'error_message' => 'An error has occurred.',
  );
  return $batch;
}

/**
 * Batch worker function.
 *
 * Callback for batch_set().
 *
 * @param string $file_path
 *   path to image file
 * @param array $form_state
 *   array of form state
 * @param array $context
 *   batch helper array
 *
 * @ingroup callbacks
 */
function media_watermark_process_multiple_images($file_path, $form_state, &$context) {
  $context['results'][] = $file_path;
  // Optional message displayed under the progressbar.
  $context['message'] = t('Processing images "@title"', array('@title' => $file_path));
  media_watermark_create_image($file_path, $form_state);
}

/**
 * Perform tasks when a batch is complete.
 *
 * Callback for batch_set().
 *
 * @param bool $success
 *   A boolean indicating whether the batch operation successfully concluded.
 * @param int $results
 *   The results from the batch process.
 * @param array $operations
 *   The batch operations that remained unprocessed. Only relevant if $success
 *   is FALSE.
 *
 * @ingroup callbacks
 */
function media_watermark_batch_finished($success, $results, $operations) {
  if ($success) {
    drupal_set_message('Added watermarks to ' . count($results) . ' images');
  }
  else {
    drupal_set_message('Finished with errors.', 'error');
  }
}

/**
 * Function which make same things as file_entity__add_upload_multiple_submit().
 *
 * @param array $form
 *   form array
 * @param array $form_state
 *   form state array
 */
function media_watermark_add_upload_multiple_submit($form, &$form_state) {
  $scheme = variable_get('file_default_scheme', 'public') . '://';
  foreach ($form_state['values']['upload'] as $uploaded_file) {

    if ($uploaded_file['status'] == 'done') {

      $source = $uploaded_file['tmppath'];
      $destination = file_stream_wrapper_uri_normalize($scheme . $uploaded_file['name']);
      // Rename it to its original name, and put it in its final home.
      // Note - not using file_move here because if we call file_get_mime
      // (in file_uri_to_object) while it has a .tmp extension, it horks.
      $destination = file_unmanaged_move($source, $destination, FILE_EXISTS_RENAME);

      $file = file_uri_to_object($destination);
      $file->status = FILE_STATUS_PERMANENT;
      file_save($file);

      $saved_files[] = $file;
      $form_state['files'][$file->fid] = $file;
    }
    else {
      // @todo: move this to element validate or something.
      form_set_error('pud', t('The specified file %name could not be uploaded.', array('%name' => $uploaded_file['name'])));
    }
  }
  $batch = media_watermark_prepare_batch($form_state);
  batch_set($batch);

  // Redirect to the file edit page.
  if (file_entity_access('edit') && module_exists('multiform')) {
    $destination = array('destination' => 'admin/content/file');
    if (isset($_GET['destination'])) {
      $destination = drupal_get_destination();
      unset($_GET['destination']);
    }
    $form_state['redirect'] = array(
      'admin/content/file/edit-multiple/' . implode(' ', array_keys($form_state['files'])),
      array('query' => $destination),
    );
  }
  else {
    $form_state['redirect'] = 'admin/content/file';
  }
}

/**
 * Helper function to get image extension.
 *
 * @param $file_name
 * @return string
 */
function media_watermark_get_file_extension($file_name) {
  return substr(strrchr($file_name, '.'), 1);
}